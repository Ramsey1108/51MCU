C51 COMPILER V9.00   18B20                                                                 12/20/2021 21:16:13 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE 18B20
OBJECT MODULE PLACED IN 18b20.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE 18b20.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include  "wendu18b20.h"
   2          #include  "lcd.h"
   3          #define uchar unsigned char
   4          #define uint unsigned int       // 这些宏定义都可以在头文件 .h 里定义
   5          uchar dis3[] = "temp:";
   6          sbit ds=P2^7;                                    //温度传感器信号线
   7          uint temp;
   8          float f_temp;
   9          /*******************************************************************/
  10          /*                                                                 */
  11          /* 18B20复位，初始化函数函数                                       */
  12          /*                                                                 */
  13          /*******************************************************************/
  14          void dsreset(void)   
  15          {
  16   1        uint i;
  17   1        ds=0;
  18   1        i=103;
  19   1        while(i>0)i--;//提供480-950us延时
  20   1        ds=1;
  21   1        i=4; 
  22   1        while(i>0)i--;//提供60-240us的延时；单片机检测到低电平复位成功
  23   1      }
  24          /*******************************************************************/
  25          /*                                                                 */
  26          /* 18B20读1位数据函数                                              */
  27          /*                                                                 */
  28          /*******************************************************************/
  29          bit tempreadbit(void)  
  30          {
  31   1         uint i;
  32   1         bit dat;
  33   1         ds=0;i++;          //i++ 起延时作用
  34   1         ds=1;i++;i++;
  35   1         dat=ds;           //ds为低电平则读0反之则为1
  36   1         i=8;while(i>0)i--;   //提供延时
  37   1         return (dat);
  38   1      }
  39          /*******************************************************************/
  40          /*                                                                 */
  41          /* 18B20读1字节数据函数                                              */
  42          /*                                                                 */
  43          /*******************************************************************/
  44          uchar tempread(void)   
  45          {
  46   1        uchar i,j,dat;
  47   1        dat=0;
  48   1        for(i=1;i<=8;i++)
  49   1        {
  50   2          j=tempreadbit();
  51   2          dat=(j<<7)|(dat>>1);   //读出的数据最低位在最前面，这样刚好一个字节在DAT里
  52   2        }
  53   1        return(dat);
  54   1      }
  55          /*******************************************************************/
C51 COMPILER V9.00   18B20                                                                 12/20/2021 21:16:13 PAGE 2   

  56          /*                                                                 */
  57          /* 18B20写1字节数据函数                                              */
  58          /*                                                                 */
  59          /*******************************************************************/
  60          void tempwritebyte(uchar dat)  
  61          {
  62   1        uint i;
  63   1        uchar j;
  64   1        bit testb;
  65   1        for(j=1;j<=8;j++)
  66   1        {
  67   2          testb=dat&0x01;
  68   2          dat=dat>>1;
  69   2          if(testb)     //写 1
  70   2          {
  71   3            ds=0;
  72   3            i++;i++;
  73   3            ds=1;
  74   3            i=8;
  75   3            while(i>0)i--;
  76   3          }
  77   2          else
  78   2          {
  79   3            ds=0;       //写 0
  80   3            i=8;while(i>0)i--;
  81   3            ds=1;
  82   3            i++;i++;
  83   3          }
  84   2      
  85   2        }
  86   1      }
  87          /*******************************************************************/
  88          /*                                                                 */
  89          /* 18B20开始获取温度并转换                                         */
  90          /*                                                                 */
  91          /*******************************************************************/
  92          void tempchange(void) {
  93   1        dsreset();
  94   1        delay(1);
  95   1        tempwritebyte(0xcc);  // 写跳过读ROM指令
  96   1        tempwritebyte(0x44);  // 写温度转换指令
  97   1      }
  98          /*******************************************************************/
  99          /*                                                                 */
 100          /* 18B20读取寄存器中存储的温度数据                                 */
 101          /*                                                                 */
 102          /*******************************************************************/
 103          uint get_temp()        
 104          {
 105   1        uchar a,b;
 106   1        dsreset();
 107   1        delay(1);
 108   1        tempwritebyte(0xcc);
 109   1        tempwritebyte(0xbe);  //读取RAM
 110   1        a=tempread();         //读低8位
 111   1        b=tempread();         //读高8位
 112   1        temp=b;
 113   1        temp<<=8;            //两个字节组合为1个字
 114   1        temp=temp|a;
 115   1        f_temp=temp*0.0625;      //温度在寄存器中为12位 分辨率位0.0625°
 116   1        temp=f_temp*10+0.5;    //乘以10表示小数点后面只取1位，加0.5是四舍五入
 117   1        f_temp=f_temp+0.05; 
C51 COMPILER V9.00   18B20                                                                 12/20/2021 21:16:13 PAGE 3   

 118   1        return temp;         //temp是整型
 119   1      }
 120          /*******************************************************************/
 121          /*                                                                 */
 122          /*                              18B20温度显示                                      */
 123          /*                                                                 */
 124          /*******************************************************************/
 125          void tempdisplay()                                        //
 126          {
 127   1      uchar i;
 128   1       uint mm;
 129   1       tempchange();
 130   1      mm=get_temp(); 
 131   1      dis3[5]=mm%1000/100+'0';
 132   1      dis3[6]=mm%100/10+'0';
 133   1      dis3[7]='.';
 134   1      dis3[8]=mm%10+'0';
 135   1      
 136   1      write_com(0x80+0x40); 
 137   1      
 138   1      // uchar t;
 139   1      for(i=0;i<9;i++)
 140   1              {
 141   2                      write_date(dis3[i]);
 142   2                      delay(10);
 143   2              }
 144   1      //搞完复位
 145   1      //lcd_wcmd(0x01);
 146   1      //delay1(10);   
 147   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    443    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     12       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
