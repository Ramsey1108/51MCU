C51 COMPILER V9.00   SHIXUN                                                                12/30/2021 01:21:45 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE SHIXUN
OBJECT MODULE PLACED IN shixun.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE shixun.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*********************************************************************
   2          Ŀ51Ƭ΢Ϣͣpostģʽ
   3          ݣͨMCUλESP8266wifiģĿƺãʵstc89c51΢Ϣ
   4          ע⣺һ11.0592MHz
   5          UIDڰͷע½ɿԼUID΢ϢҪֻ΢ţbemfa.comڿ̨а󶨼ɡ
             -
   6          QQȺ824273231
   7          ͷƹbemfa.com
   8          ʱ䣺2020/04/02
   9          ע⣺ESP8266-01Ĭ115200ʣҪôڵָesp8266Ϊ9600
  10          ķUSBתڰӵESP8266115200  AT+UART=9600,8,1,0,0   //ĩβлس
  11          USBתڰ߷tx--rx ,rx--tx,gnd-gnd,3.3v--3.3v,EN--3.3v //esp8266--USBתڰ
  12          ٷĵhttp://www.cloud.bemfa.com/docs/#/?id=_51-tcp%e5%88%9b%e5%ae%a2%e4%ba%91
  13          
  14          LEDP10
  15          ********************************************************************/
  16          #include  "lcd.h"
  17          //#include <reg52.h>  
  18          #include <stdio.h>
  19          #include <string.h>//ͷļ
  20          //#include <intrins.h>
  21          #define uint unsigned int
  22          #define uchar unsigned char
  23          //Լ̵
  24          sbit IN1 = P2^0;
  25          //
  26          sbit RedLed=P1^2;
  27          sbit WhileLed=P1^1;
  28          sbit BuleLed=P1^0;
  29          //ʼLED
  30          //uchar table2[]="l";
  31          //
  32          unsigned char code LEDTAB[] =               //--- Ƶʾ ---
  33          {
  34            0xfe,0xfd,0xfb,0xf7,0xef,0xdf,0xbf,0x7f,0xfc,0xf3,0xcf,0x3f,0xfa,0xf5,0xaf,0x5f,
  35            0xf0,0x0f,0x7f,0xbf,0xdf,0xef,0xf7,0xfb,0xfd,0xfe,0x3f,0xcf,0xf3,0xfc,
  36            0x5f,0xaf,0xf5,0xfa,0x0f,0xf0,
  37          };
  38          //sbit LED1=P1^0;//Ƶ
  39          //sbit LED2=P1^5;//
  40          //sbit LED3=P1^2;//
  41          
  42          //Ҫ޸ĵĲ
  43          #define Ssid  "Ramsey"                                                                                  //WIFIƣ޸ΪԼ·WIFIƣ֧
  44          #define PassWord  "11223344"              //WIFI룬޸ΪԼ·
  45          #define Uid  "d6b1cbc7d2a2103af9d33b83b2bf652c" //ͷUIDԿ̨ȡ
  46          #define TopicLed  "Light001" //ͷƿ̨Զ壬appҪһ
  47          
  48          /*****************ر**************/
  49          uchar Receive;  //յֽ
  50          uchar i,i2,count; //ʱñ
  51          uint n;                                         //յֽڵĸ
  52          uchar flag=0; //־λǷͨڷMCU
  53          uchar connected = 0;  //־λǷӷ
  54          uchar Recive_table[86]; //ڽwifiģ鷴MCUϵ
C51 COMPILER V9.00   SHIXUN                                                                12/30/2021 01:21:45 PAGE 2   

  55          
  56          /*******************************************************************
  57          ƣʱ
  58          ã뼶ʱ΢ʱΪշȴ.......
  59          ********************************************************************/
  60          void ms_delay(uint t)
  61          {
  62   1            uint i,j;
  63   1            for(i=t;i>0;i--)
  64   1             for(j=110;j>0;j--);
  65   1      }
  66          
  67          void us_delay(uchar t)
  68          {
  69   1            while(t--);
  70   1      }
  71          
  72          
  73          
  74          /********************************************************************
  75          ƣʷ
  76          ãʷT1ʱʵ֣ҲMCUڲĲʷ
  77          ԲֵͬʽݼĴο㣬ʵ
  78          첽ͨѶԣ÷ʽãѡһ֡
  79          ********************************************************************/
  80          void Uart_Init()//ʹöʱ1ΪʷSTC89C52STC89C51AT89C51STC12C560S2Ⱦɣ
  81          {
  82   1              SCON=0x50;     //ΪпԷʽ18λ첽ͨѶ,жϡ
  83   1              //һ֡ϢΪ10λ1λʼλ8λλλȣ1λֹͣλ
  84   1              PCON=0x80;     //SMODѡλΪ1SMOD=1.
  85   1              TMOD=0x21;    //öʱ1Ϊʷģʽ28λԶװ
  86   1              TH1=0xFA ;//9600 TH1=256-FOSC/16/12/
  87   1              TL1=TH1;
  88   1              EA=1;                            //жϴ
  89   1              ES=0;                             //رմж
  90   1              TR1=1;                     //ʱ1
  91   1      
  92   1              TH0=0xD8;                  //ʱ10ms
  93   1              TL0=0xF0;
  94   1              ET0=1;
  95   1              TR0=1;
  96   1      }
  97          
  98          
  99          
 100          
 101          /********************************************************************
 102          ƣڷͺ
 103          ܣMCUӵ豸ݣ˴WIFIģESP8266)
 104          ********************************************************************/
 105          void Send_Uart(uchar value)
 106          {
 107   1            ES=0;         //رմж
 108   1            TI=0;         //巢ж־λ
 109   1            SBUF=value;     //
 110   1            while(TI==0);    //ȴ
 111   1            TI=0;         //巢ж־λ
 112   1            ES=1;         //ж
 113   1      }
 114          /********************************************************************
 115          ƣڷ
 116          : ͨڷָWIFIģ飬Աʵ߽Ϳƣس
C51 COMPILER V9.00   SHIXUN                                                                12/30/2021 01:21:45 PAGE 3   

 117          ********************************************************************/
 118          void SerialSend(uchar *puf) // ָ*pufַָ               
 119          {
 120   1      
 121   1            while(*puf!='\0')    //ոѭ
 122   1            {
 123   2                 Send_Uart(*puf);  //WIFIģ鷢Ϳָ
 124   2                 us_delay(5);
 125   2                 puf++;      
 126   2            }
 127   1            us_delay(5);
 128   1            Send_Uart('\r');//س
 129   1            us_delay(5);
 130   1            Send_Uart('\n');   //
 131   1      }   
 132          
 133          /********************************************************************
 134          ƣڷ
 135          : ͨڷָWIFIģ飬س
 136          ********************************************************************/
 137          void SerialSend_byte(uchar *puf) // ָ*pufַָ               
 138          {
 139   1      
 140   1            while(*puf!='\0')    //ոѭ
 141   1            {
 142   2                 Send_Uart(*puf);  //WIFIģ鷢Ϳָ
 143   2                 us_delay(5);
 144   2                 puf++;      
 145   2            }
 146   1      }   
 147          
 148          
 149          /********************************************************************
 150          ƣ
 151          ãһӲͻΪ豸ߣʽ30sһ
 152          ж1еãͷݺһУҲ൱
 153          ********************************************************************/
 154          void Ping(void)
 155          {       
 156   1        SerialSend("cmd=0&msg=ping"); //
 157   1      }
 158          /********************************************************************
 159          ƣˮƺ
 160          ã
 161          ********************************************************************/
 162          void WaterLamp()
 163          {
 164   1              uint k;
 165   1         for(k=0;k<45;k++)
 166   1         {
 167   2                      P1 = LEDTAB[k];
 168   2                      ms_delay(100);  
 169   2         }    
 170   1      }
 171          
 172          /********************************************************************
 173          ƣ
 174          ãִ
 175          ********************************************************************/
 176          void main()
 177          {   
 178   1                      //ʾ
C51 COMPILER V9.00   SHIXUN                                                                12/30/2021 01:21:45 PAGE 4   

 179   1      //              uchar i;
 180   1                      initdisplay();//ʼʾ
 181   1                      //Ledflash(6);
 182   1                      //
 183   1                      memset(Recive_table,'\0',sizeof Recive_table);//
 184   1                      Uart_Init();//ʹöĲʷ
 185   1      
 186   1      
 187   1                      ms_delay(1000);
 188   1                      SerialSend("AT+RST");     //wifiģ
 189   1                      ms_delay(1000);
 190   1                      SerialSend("AT");     //wifiģ
 191   1                      ms_delay(1000);
 192   1                      SerialSend("AT+CWMODE=3"); //·ģʽ 1 stationģʽ 2 AP·ģʽ 3 station+APģʽ
 193   1                      ms_delay(1000);
 194   1                      SerialSend("AT+CWJAP=\""Ssid"\",\""PassWord"\"");//ģSSID:WIFI, PWD: ȫͼģʽWPA2-
             -PSK
 195   1                      ms_delay(8000);
 196   1                      SerialSend("AT+CIPMODE=1"); //͸ģʽ
 197   1                      ms_delay(1000);
 198   1                      SerialSend("AT+CIPSTART=\"TCP\",\"bemfa.com\",8344");  // ӷͶ˿
 199   1                      ms_delay(1000);
 200   1                      SerialSend("AT+CIPSEND"); //͸ģʽ淢Ķ
 201   1                      ms_delay(1000);
 202   1                      
 203   1              
 204   1                //ͶָԭʽΪ
 205   1                      //cmd=1&uid=***UID***&topic=***Topic***
 206   1                      SerialSend_byte("cmd=1&uid=");
 207   1                      SerialSend_byte(Uid);
 208   1                      SerialSend_byte("&topic=");
 209   1                      SerialSend_byte(TopicLed); //ĿƵƵ
 210   1                      us_delay(5);
 211   1                      Send_Uart('\r');//س
 212   1                      us_delay(5);
 213   1                      Send_Uart('\n');   //
 214   1                      
 215   1                      
 216   1                      connected = 1; //ʾӳɹԷ
 217   1      
 218   1                      //
 219   1                      //P1=0;
 220   1                      //ms_delay(1000);
 221   1                      IN1=0;  //
 222   1      
 223   1                      while(1)
 224   1                      {        
 225   2                              
 226   2                                      if(flag == 1){
 227   3                                              
 228   3                                              //ʵյָcmd=2&uid=4d9ec352e0376f2110a0c601a2857225&topic=light002&msg=on
 229   3                                              //ַƥ䣬⵽ַmsg=onʱִп 
 230   3                                              //ж⣬Լֲͬ豸: if(strstr(Recive_table,"light002&msg=on
             -"))
 231   3                                              if(strstr(Recive_table,"&msg=on")){ 
 232   4                                                                      //LED1=0;   //򿪵ƣP10øߵƽ
 233   4                                                                      //LED2=0;
 234   4                                                                      //LED3=0;
 235   4                                                                      //P1=0Xfe;
 236   4                                                                      //IN1=1;  //
 237   4                                                                      //ms_delay(50);
 238   4                                                                      //WaterLamp();
C51 COMPILER V9.00   SHIXUN                                                                12/30/2021 01:21:45 PAGE 5   

 239   4                                                                      RedLed=0;
 240   4                                                                      Ledflash(3);
 241   4                                                                      ms_delay(10);
 242   4      
 243   4                                              }
 244   3                                              else if(strstr(Recive_table,"&msg=off"))
 245   3                                              { ////⵽ַmsg=offʱִйص
 246   4                                                                      //P1=0xff;      //رյƣP10õ͵ƽ
 247   4                                                                      //ms_delay(50);
 248   4                                                                      //IN1=0;  //
 249   4                                                                      RedLed=1;
 250   4                                                                      Ledflash(6);
 251   4                                                                      ms_delay(10);
 252   4                                              }
 253   3                                              else if(strstr(Recive_table,"&msg=led1on"))
 254   3                                              { ////⵽ַmsg=led1onʱִп׵
 255   4                                                                  WhileLed=0;
 256   4                                                                      Ledflash(2);
 257   4                                                                      ms_delay(10);   
 258   4                                              }
 259   3                                              else if(strstr(Recive_table,"&msg=led1off"))
 260   3                                              { ////⵽ַmsg=led1offʱִйذ׵
 261   4                                                                      WhileLed=1;
 262   4                                                                      Ledflash(5);
 263   4                                                                      ms_delay(10);
 264   4                                              }
 265   3                                              else if(strstr(Recive_table,"&msg=led2on"))
 266   3                                              { ////⵽ַmsg=offʱִп
 267   4                                                                      BuleLed=0;
 268   4                                                                      Ledflash(1);
 269   4                                                                      ms_delay(10);   
 270   4                                              }
 271   3                                              else if(strstr(Recive_table,"&msg=led2off"))
 272   3                                              { ////⵽ַmsg=led2offʱִй
 273   4                                                                      BuleLed=1;
 274   4                                                                      Ledflash(4);
 275   4                                                                      ms_delay(10);
 276   4                                              }
 277   3                                              else if(strstr(Recive_table,"&msg=show"))
 278   3                                              { ////⵽ַmsg=showʱִеƹ
 279   4                                                                      //BuleLed=1;
 280   4                                                                      Ledflash(7);
 281   4                                                                      WaterLamp();
 282   4                                                                      
 283   4                                                                      ms_delay(10);
 284   4                                              }
 285   3                                              else if(strstr(Recive_table,"&msg=alloff"))
 286   3                                              { ////⵽ַmsg=alloffʱرȫ
 287   4                                                                      //BuleLed=1;
 288   4                                                                      P1=0xff;        //رյƣP10õ͵ƽ
 289   4                                                                      Ledflash(8);
 290   4                                                                      ms_delay(10);
 291   4                                              }
 292   3                                              else if(strstr(Recive_table,"ERROR"))
 293   3                                              { //߻ϣ
 294   4                                                                              connected = 1;
 295   4                                                                              SerialSend("AT+CIPMODE=1"); //͸ģʽ
 296   4                                                                              ms_delay(1000);
 297   4                                                                              SerialSend("AT+CIPSTART=\"TCP\",\"bemfa.com\",8344");  // ӷͶ˿
 298   4                                                                              ms_delay(1000);
 299   4                                                                              SerialSend("AT+CIPSEND"); //͸ģʽ淢Ķ
 300   4                                                                              ms_delay(1000);
C51 COMPILER V9.00   SHIXUN                                                                12/30/2021 01:21:45 PAGE 6   

 301   4                                                      
 302   4                                                                              //ͶָԭʽΪ
 303   4                                                                              //cmd=1&uid=***UID***&topic=***Topic***
 304   4                                                                              SerialSend_byte("cmd=1&uid=");
 305   4                                                                              SerialSend_byte(Uid);
 306   4                                                                              SerialSend_byte("&topic=");
 307   4                                                                              SerialSend_byte(TopicLed);
 308   4                                                                              us_delay(5);
 309   4                                                                              Send_Uart('\r');//س
 310   4                                                                              us_delay(5);
 311   4                                                                              Send_Uart('\n');   //
 312   4                                                                              connected = 1; //ʾӳɹԷ
 313   4      
 314   4                                              }
 315   3                                              memset(Recive_table,'\0',sizeof Recive_table);//
 316   3                                              flag=0;
 317   3                                              
 318   3                                      }
 319   2            }         
 320   1      }
 321          
 322          /*********************************************************************
 323          ƣͨѶж
 324          ãͻսúӦı־λ0ʵģ
 325                   շ
 326          
 327          
 328          ********************************************************************/
 329          
 330          void Uart_Interrupt() interrupt 4        
 331          {
 332   1      
 333   1            if(RI==1)
 334   1            {
 335   2                 RI=0;
 336   2                 Receive=SBUF;        //MCUwifiģ鷴
 337   2                 Recive_table[i]=Receive;      
 338   2                 i++;         
 339   2                 if((Receive =='\n')){
 340   3                                                      i=0;
 341   3                                                      flag = 1;
 342   3                                      }
 343   2                              }
 344   1            else TI=0;   
 345   1                      
 346   1      }
 347          
 348          //ʱʹ
 349          //30sһΣһӲݣΪ豸
 350          void timer0isr(void) interrupt 1  
 351          {
 352   1              TH0=0xD8;
 353   1              TL0=0xF0;
 354   1              i2++;
 355   1              if(i2==100)
 356   1              {
 357   2                  i2=0;
 358   2                                                      count++;
 359   2                                                      if(count>=30) //30룬޸
 360   2                                                      {
 361   3                                                              if(connected == 1){
 362   4                                                                                      Ping();   //
C51 COMPILER V9.00   SHIXUN                                                                12/30/2021 01:21:45 PAGE 7   

 363   4                                                              }
 364   3      
 365   3                                                              count=0;
 366   3                                                      }               
 367   2              }       
 368   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    772    ----
   CONSTANT SIZE    =    317    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     94    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
