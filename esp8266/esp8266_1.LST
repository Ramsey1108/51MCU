C51 COMPILER V9.00   ESP8266_1                                                             12/29/2021 15:08:07 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE ESP8266_1
OBJECT MODULE PLACED IN esp8266_1.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE esp8266_1.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*********************************************************************
   2          Ŀ51Ƭ΢Ϣͣpostģʽ
   3          ݣͨMCUλESP8266wifiģĿƺãʵstc89c51΢Ϣ
   4          ע⣺һ11.0592MHz
   5          UIDڰͷע½ɿԼUID΢ϢҪֻ΢ţbemfa.comڿ̨а󶨼ɡ
             -
   6          QQȺ824273231
   7          ͷƹbemfa.com
   8          ʱ䣺2020/04/02
   9          ע⣺ESP8266-01Ĭ115200ʣҪôڵָesp8266Ϊ9600
  10          ķUSBתڰӵESP8266115200  AT+UART=9600,8,1,0,0   //ĩβлس
  11          USBתڰ߷tx--rx ,rx--tx,gnd-gnd,3.3v--3.3v,EN--3.3v //esp8266--USBתڰ
  12          ٷĵhttp://www.cloud.bemfa.com/docs/#/?id=_51-tcp%e5%88%9b%e5%ae%a2%e4%ba%91
  13          
  14          LEDP10
  15          ********************************************************************/
  16          #include <reg52.h>  
  17          #include <stdio.h>
  18          #include <string.h>//ͷļ
  19          #include <intrins.h>
  20          #define uint unsigned int
  21          #define uchar unsigned char
  22          //Լ̵
  23          sbit IN1 = P2^0;
  24          //ʼLED
  25          //uchar table2[]="l";
  26          uchar code table3[]="luminance:      ";
  27          uchar code table4[]="The Led is: ON  ";
  28          uchar code table5[]="The Led is: Off ";
  29          uchar code table6[]="The Led is: ON  ";
  30          uchar code table7[]="The Led is: ON  ";
  31          uchar code table8[]="The Led is: ON  ";
  32          //
  33          unsigned char code LEDTAB[] =               //--- Ƶʾ ---
  34          {
  35            0xfe,0xfd,0xfb,0xf7,0xef,0xdf,0xbf,0x7f,0xfc,0xf3,0xcf,0x3f,0xfa,0xf5,0xaf,0x5f,
  36            0xf0,0x0f,0x7f,0xbf,0xdf,0xef,0xf7,0xfb,0xfd,0xfe,0x3f,0xcf,0xf3,0xfc,
  37            0x5f,0xaf,0xf5,0xfa,0x0f,0xf0,
  38          };
  39          //sbit LED1=P1^0;//Ƶ
  40          //sbit LED2=P1^5;//
  41          //sbit LED3=P1^2;//
  42          
  43          //Ҫ޸ĵĲ
  44          #define Ssid  "Ramsey"                                                                                  //WIFIƣ޸ΪԼ·WIFIƣ֧
  45          #define PassWord  "11223344"              //WIFI룬޸ΪԼ·
  46          #define Uid  "d6b1cbc7d2a2103af9d33b83b2bf652c" //ͷUIDԿ̨ȡ
  47          #define TopicLed  "Light001" //ͷƿ̨Զ壬appҪһ
  48          
  49          /*****************ر**************/
  50          uchar Receive;  //յֽ
  51          uchar i,i2,count; //ʱñ
  52          uint n;                                         //յֽڵĸ
  53          uchar flag=0; //־λǷͨڷMCU
  54          uchar connected = 0;  //־λǷӷ
C51 COMPILER V9.00   ESP8266_1                                                             12/29/2021 15:08:07 PAGE 2   

  55          uchar Recive_table[100]; //ڽwifiģ鷴MCUϵ
  56          
  57          /*******************************************************************
  58          ƣʱ
  59          ã뼶ʱ΢ʱΪշȴ.......
  60          ********************************************************************/
  61          void ms_delay(uint t)
  62          {
  63   1            uint i,j;
  64   1            for(i=t;i>0;i--)
  65   1             for(j=110;j>0;j--);
  66   1      }
  67          
  68          void us_delay(uchar t)
  69          {
  70   1            while(t--);
  71   1      }
  72          
  73          
  74          
  75          /********************************************************************
  76          ƣʷ
  77          ãʷT1ʱʵ֣ҲMCUڲĲʷ
  78          ԲֵͬʽݼĴο㣬ʵ
  79          첽ͨѶԣ÷ʽãѡһ֡
  80          ********************************************************************/
  81          void Uart_Init()//ʹöʱ1ΪʷSTC89C52STC89C51AT89C51STC12C560S2Ⱦɣ
  82          {
  83   1              SCON=0x50;     //ΪпԷʽ18λ첽ͨѶ,жϡ
  84   1              //һ֡ϢΪ10λ1λʼλ8λλλȣ1λֹͣλ
  85   1              PCON=0x80;     //SMODѡλΪ1SMOD=1.
  86   1              TMOD=0x21;    //öʱ1Ϊʷģʽ28λԶװ
  87   1              TH1=0xFA ;//9600 TH1=256-FOSC/16/12/
  88   1              TL1=TH1;
  89   1              EA=1;                            //жϴ
  90   1              ES=0;                             //رմж
  91   1              TR1=1;                     //ʱ1
  92   1      
  93   1              TH0=0xD8;                  //ʱ10ms
  94   1              TL0=0xF0;
  95   1              ET0=1;
  96   1              TR0=1;
  97   1      }
  98          
  99          
 100          
 101          
 102          /********************************************************************
 103          ƣڷͺ
 104          ܣMCUӵ豸ݣ˴WIFIģESP8266)
 105          ********************************************************************/
 106          void Send_Uart(uchar value)
 107          {
 108   1            ES=0;         //رմж
 109   1            TI=0;         //巢ж־λ
 110   1            SBUF=value;     //
 111   1            while(TI==0);    //ȴ
 112   1            TI=0;         //巢ж־λ
 113   1            ES=1;         //ж
 114   1      }
 115          /********************************************************************
 116          ƣڷ
C51 COMPILER V9.00   ESP8266_1                                                             12/29/2021 15:08:07 PAGE 3   

 117          : ͨڷָWIFIģ飬Աʵ߽Ϳƣس
 118          ********************************************************************/
 119          void SerialSend(uchar *puf) // ָ*pufַָ               
 120          {
 121   1      
 122   1            while(*puf!='\0')    //ոѭ
 123   1            {
 124   2                 Send_Uart(*puf);  //WIFIģ鷢Ϳָ
 125   2                 us_delay(5);
 126   2                 puf++;      
 127   2            }
 128   1            us_delay(5);
 129   1            Send_Uart('\r');//س
 130   1            us_delay(5);
 131   1            Send_Uart('\n');   //
 132   1      }   
 133          
 134          /********************************************************************
 135          ƣڷ
 136          : ͨڷָWIFIģ飬س
 137          ********************************************************************/
 138          void SerialSend_byte(uchar *puf) // ָ*pufַָ               
 139          {
 140   1      
 141   1            while(*puf!='\0')    //ոѭ
 142   1            {
 143   2                 Send_Uart(*puf);  //WIFIģ鷢Ϳָ
 144   2                 us_delay(5);
 145   2                 puf++;      
 146   2            }
 147   1      }   
 148          
 149          
 150          /********************************************************************
 151          ƣ
 152          ãһӲͻΪ豸ߣʽ30sһ
 153          ж1еãͷݺһУҲ൱
 154          ********************************************************************/
 155          void Ping(void)
 156          {       
 157   1        SerialSend("cmd=0&msg=ping"); //
 158   1      }
 159          /********************************************************************
 160          ƣˮƺ
 161          ã
 162          ********************************************************************/
 163          void WaterLamp()
 164          {
 165   1              uint k;
 166   1         for(k=0;k<45;k++)
 167   1         {
 168   2                      P1 = LEDTAB[k];
 169   2                      ms_delay(100);  
 170   2         }    
 171   1      }
 172          
 173          /********************************************************************
 174          ƣ
 175          ãִ
 176          ********************************************************************/
 177          void main()
 178          {   
C51 COMPILER V9.00   ESP8266_1                                                             12/29/2021 15:08:07 PAGE 4   

 179   1                      memset(Recive_table,'\0',sizeof Recive_table);//
 180   1                      Uart_Init();//ʹöĲʷ
 181   1      
 182   1      
 183   1                      ms_delay(1000);
 184   1                      SerialSend("AT+RST");     //wifiģ
 185   1                      ms_delay(1000);
 186   1                      SerialSend("AT");     //wifiģ
 187   1                      ms_delay(1000);
 188   1                      SerialSend("AT+CWMODE=3"); //·ģʽ 1 stationģʽ 2 AP·ģʽ 3 station+APģʽ
 189   1                      ms_delay(1000);
 190   1                      SerialSend("AT+CWJAP=\""Ssid"\",\""PassWord"\"");//ģSSID:WIFI, PWD: ȫͼģʽWPA2-
             -PSK
 191   1                      ms_delay(8000);
 192   1                      SerialSend("AT+CIPMODE=1"); //͸ģʽ
 193   1                      ms_delay(1000);
 194   1                      SerialSend("AT+CIPSTART=\"TCP\",\"bemfa.com\",8344");  // ӷͶ˿
 195   1                      ms_delay(1000);
 196   1                      SerialSend("AT+CIPSEND"); //͸ģʽ淢Ķ
 197   1                      ms_delay(1000);
 198   1                      
 199   1              
 200   1                //ͶָԭʽΪ
 201   1                      //cmd=1&uid=***UID***&topic=***Topic***
 202   1                      SerialSend_byte("cmd=1&uid=");
 203   1                      SerialSend_byte(Uid);
 204   1                      SerialSend_byte("&topic=");
 205   1                      SerialSend_byte(TopicLed); //ĿƵƵ
 206   1                      us_delay(5);
 207   1                      Send_Uart('\r');//س
 208   1                      us_delay(5);
 209   1                      Send_Uart('\n');   //
 210   1                      
 211   1                      
 212   1                      connected = 1; //ʾӳɹԷ
 213   1      
 214   1                      //
 215   1                      //P1=0;
 216   1                      ms_delay(1000);
 217   1                      IN1=0;  //
 218   1                      while(1)
 219   1                      {        
 220   2                              
 221   2                                      if(flag == 1){
 222   3                                              
 223   3                                              //ʵյָcmd=2&uid=4d9ec352e0376f2110a0c601a2857225&topic=light002&msg=on
 224   3                                              //ַƥ䣬⵽ַmsg=onʱִп 
 225   3                                              //ж⣬Լֲͬ豸: if(strstr(Recive_table,"light002&msg=on
             -"))
 226   3                                              if(strstr(Recive_table,"&msg=on")){ 
 227   4                                                                      //LED1=0;   //򿪵ƣP10øߵƽ
 228   4                                                                      //LED2=0;
 229   4                                                                      //LED3=0;
 230   4                                                                      //P1=0Xfe;
 231   4                                                                      IN1=1;  //
 232   4                                                                      ms_delay(50);
 233   4                                                                      WaterLamp();
 234   4                                              }else if(strstr(Recive_table,"&msg=off")){ ////⵽ַmsg=offʱִйص
 235   4                                                                      P1=0xff;        //رյƣP10õ͵ƽ
 236   4                                                                      ms_delay(50);
 237   4                                                                      IN1=0;  //
 238   4                                              }else if(strstr(Recive_table,"ERROR")){ //߻ϣ
C51 COMPILER V9.00   ESP8266_1                                                             12/29/2021 15:08:07 PAGE 5   

 239   4                                                                              connected = 1;
 240   4                                                                              SerialSend("AT+CIPMODE=1"); //͸ģʽ
 241   4                                                                              ms_delay(1000);
 242   4                                                                              SerialSend("AT+CIPSTART=\"TCP\",\"bemfa.com\",8344");  // ӷͶ˿
 243   4                                                                              ms_delay(1000);
 244   4                                                                              SerialSend("AT+CIPSEND"); //͸ģʽ淢Ķ
 245   4                                                                              ms_delay(1000);
 246   4                                                      
 247   4                                                                              //ͶָԭʽΪ
 248   4                                                                              //cmd=1&uid=***UID***&topic=***Topic***
 249   4                                                                              SerialSend_byte("cmd=1&uid=");
 250   4                                                                              SerialSend_byte(Uid);
 251   4                                                                              SerialSend_byte("&topic=");
 252   4                                                                              SerialSend_byte(TopicLed);
 253   4                                                                              us_delay(5);
 254   4                                                                              Send_Uart('\r');//س
 255   4                                                                              us_delay(5);
 256   4                                                                              Send_Uart('\n');   //
 257   4                                                                              connected = 1; //ʾӳɹԷ
 258   4      
 259   4                                              }
 260   3                                              memset(Recive_table,'\0',sizeof Recive_table);//
 261   3                                              flag=0;
 262   3                                              
 263   3                                      }
 264   2            }         
 265   1      }
 266          
 267          /*********************************************************************
 268          ƣͨѶж
 269          ãͻսúӦı־λ0ʵģ
 270                   շ
 271          
 272          
 273          ********************************************************************/
 274          
 275          void Uart_Interrupt() interrupt 4        
 276          {
 277   1      
 278   1            if(RI==1)
 279   1            {
 280   2                 RI=0;
 281   2                 Receive=SBUF;        //MCUwifiģ鷴
 282   2                 Recive_table[i]=Receive;      
 283   2                 i++;         
 284   2                 if((Receive =='\n')){
 285   3                                                      i=0;
 286   3                                                      flag = 1;
 287   3                                      }
 288   2                              }
 289   1            else TI=0;   
 290   1                      
 291   1      }
 292          
 293          //ʱʹ
 294          //30sһΣһӲݣΪ豸
 295          void timer0isr(void) interrupt 1  
 296          {
 297   1              TH0=0xD8;
 298   1              TL0=0xF0;
 299   1              i2++;
 300   1              if(i2==100)
C51 COMPILER V9.00   ESP8266_1                                                             12/29/2021 15:08:07 PAGE 6   

 301   1              {
 302   2                  i2=0;
 303   2                                                      count++;
 304   2                                                      if(count>=30) //30룬޸
 305   2                                                      {
 306   3                                                              if(connected == 1){
 307   4                                                                                      Ping();   //
 308   4                                                              }
 309   3      
 310   3                                                              count=0;
 311   3                                                      }               
 312   2              }       
 313   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    593    ----
   CONSTANT SIZE    =    347    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =    108    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
